<!DOCTYPE html>
<html>

<head>
    <title>Office Locator - CalFresh</title>
    <<meta charset="utf-8">
        <meta name="viewport" content='width=device-width, initial-scale=1'>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
        <link rel="stylesheet" type="text/css" href="assets/css/style.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
    <nav>
        <div class="nav-wrapper">
            <a href="#!" class="brand-logo">Logo</a>
            <a href="#" data-activates="mobile-demo" class="button-collapse"><i class="material-icons">menu</i></a>
            <ul class="right hide-on-med-and-down">
                <li><a href="#">Home</a></li>
                <li><a href="#">About</a></li>
                <li><a href="#">Programs</a></li>
                <li><a href="#">Feedback</a></li>
            </ul>
            <ul class="side-nav" id="mobile-demo">
                <li><a href="#">Home</a></li>
                <li><a href="#">About</a></li>
                <li><a href="#">Programs</a></li>
                <li><a href="#">Feedback</a></li>
            </ul>
        </div>
    </nav>
    <script src="https://www.gstatic.com/firebasejs/3.7.1/firebase.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>
    <style>
    /* Optional: Makes the sample page fill the window. */
    
    html,
    body {
        height: 100%;
        margin: 0;
        padding: 0;
    }
    
    .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
    }
    /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
    
    #map {
        height: 70%;
        width: 100%;
    }
    </style>
</head>

<body>
    <div class='container'>
        <div id="map"></div>
    </div>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.js'></script>
    <script>
    // determines language to render for map
    var langState = 'en';

    switch (langState) {
        case 'en':
            $('body').append("<script async defer src=https://maps.googleapis.com/maps/api/js?key=AIzaSyCgsIvh_6KHhGiGv8XHfTP2rUm_T42eH2E&language=en&libraries=places&callback=init />");
            break;
        case 'es':
            $('body').append("<script async defer src=https://maps.googleapis.com/maps/api/js?key=AIzaSyCgsIvh_6KHhGiGv8XHfTP2rUm_T42eH2E&language=es&libraries=places&callback=init />");
            break;
    }

    // random element utility
    var getRandomElement = function(arr, n) {
        var result = new Array(n),
            len = arr.length,
            taken = new Array(len);
        if (n > len) {
            throw new RangeError("getRandom: more elements taken than available");
        }
        while (n--) {
            var x = Math.floor(Math.random() * len);
            result[n] = arr[x in taken ? taken[x] : x];
            taken[x] = --len;
        }
        return result[0];
    };

    // format address for query string utility
    var formatAddr = function() {
      var temp;
      for (var i = 0; i < temp.length; i++) {
        if (temp[i] === ',') {
          temp.splice(i, 1);
        }
      }
      for (var j = 0; j < temp.length; i++) {
        if (temp[j] === ' ') {
          temp.splice(j, 1, '+');
        }
      }
      return temp.join(''); 
    };

    // map render callback
    function init() {
        // variable to contain LatLng object converted from the user's zip
        var zipLatLng;
        // setup our geocoder object
        var Geocoder = new google.maps.Geocoder();

        Geocoder.geocode({
            address: '94601'
        }, function(results, status) {
            if (status == 'OK') {
                // LatLng object returned by the callback passed to the '.geocode()' method
                zipLatLng = results[0].geometry.location;
                // create and assign map object
                var map = new google.maps.Map(document.getElementById('map'), {
                    center: zipLatLng,
                    // 4 is ~country-level, while 10 is ~city-level
                    zoom: 10,
                    scrollwheel: false
                });
                // style map (retro)
                // configure our map's style
                var styledMapType = new google.maps.StyledMapType(
                    [{
                        elementType: 'geometry',
                        stylers: [{
                            color: '#ebe3cd'
                        }]
                    }, {
                        elementType: 'labels.text.fill',
                        stylers: [{
                            color: '#523735'
                        }]
                    }, {
                        elementType: 'labels.text.stroke',
                        stylers: [{
                            color: '#f5f1e6'
                        }]
                    }, {
                        featureType: 'administrative',
                        elementType: 'geometry.stroke',
                        stylers: [{
                            color: '#c9b2a6'
                        }]
                    }, {
                        featureType: 'administrative.land_parcel',
                        elementType: 'geometry.stroke',
                        stylers: [{
                            color: '#dcd2be'
                        }]
                    }, {
                        featureType: 'administrative.land_parcel',
                        elementType: 'labels.text.fill',
                        stylers: [{
                            color: '#ae9e90'
                        }]
                    }, {
                        featureType: 'landscape.natural',
                        elementType: 'geometry',
                        stylers: [{
                            color: '#dfd2ae'
                        }]
                    }, {
                        featureType: 'poi',
                        elementType: 'geometry',
                        stylers: [{
                            color: '#dfd2ae'
                        }]
                    }, {
                        featureType: 'poi',
                        elementType: 'labels.text.fill',
                        stylers: [{
                            color: '#93817c'
                        }]
                    }, {
                        featureType: 'poi.park',
                        elementType: 'geometry.fill',
                        stylers: [{
                            color: '#a5b076'
                        }]
                    }, {
                        featureType: 'poi.park',
                        elementType: 'labels.text.fill',
                        stylers: [{
                            color: '#447530'
                        }]
                    }, {
                        featureType: 'road',
                        elementType: 'geometry',
                        stylers: [{
                            color: '#f5f1e6'
                        }]
                    }, {
                        featureType: 'road.arterial',
                        elementType: 'geometry',
                        stylers: [{
                            color: '#fdfcf8'
                        }]
                    }, {
                        featureType: 'road.highway',
                        elementType: 'geometry',
                        stylers: [{
                            color: '#f8c967'
                        }]
                    }, {
                        featureType: 'road.highway',
                        elementType: 'geometry.stroke',
                        stylers: [{
                            color: '#e9bc62'
                        }]
                    }, {
                        featureType: 'road.highway.controlled_access',
                        elementType: 'geometry',
                        stylers: [{
                            color: '#e98d58'
                        }]
                    }, {
                        featureType: 'road.highway.controlled_access',
                        elementType: 'geometry.stroke',
                        stylers: [{
                            color: '#db8555'
                        }]
                    }, {
                        featureType: 'road.local',
                        elementType: 'labels.text.fill',
                        stylers: [{
                            color: '#806b63'
                        }]
                    }, {
                        featureType: 'transit.line',
                        elementType: 'geometry',
                        stylers: [{
                            color: '#dfd2ae'
                        }]
                    }, {
                        featureType: 'transit.line',
                        elementType: 'labels.text.fill',
                        stylers: [{
                            color: '#8f7d77'
                        }]
                    }, {
                        featureType: 'transit.line',
                        elementType: 'labels.text.stroke',
                        stylers: [{
                            color: '#ebe3cd'
                        }]
                    }, {
                        featureType: 'transit.station',
                        elementType: 'geometry',
                        stylers: [{
                            color: '#dfd2ae'
                        }]
                    }, {
                        featureType: 'water',
                        elementType: 'geometry.fill',
                        stylers: [{
                            color: '#b9d3c2'
                        }]
                    }, {
                        featureType: 'water',
                        elementType: 'labels.text.fill',
                        stylers: [{
                            color: '#92998d'
                        }]
                    }], {
                        name: 'Styled Map'
                    }
                );
                map.mapTypes.set('styled_map', styledMapType);
                map.setMapTypeId('styled_map');
                // set map viewport
                map.setCenter(zipLatLng);
                // create service object for our map
                var Service = new google.maps.places.PlacesService(map);
                // run a .nearbySearch() for the closest SNAP office 
                Service.nearbySearch({
                    location: zipLatLng,
                    keyword: 'food stamps',
                    radius: '15000',
                }, function(results, status) {
                    if (status == google.maps.places.PlacesServiceStatus.OK) {
                        // iterate through results
                        for (var i = 0; i < results.length; i++) {
                            var result = results[i];
                            var placeLatLng = results[i].geometry.location;
                            // labels for each marker
                            var labels = ['🍠', '🍄', '🥒', '🌶', '🌽', '🥕', '🥔', '🍆', '🥑', '🍅', '🥝', '🍓', '🍇', '🍊', '🍉', '🍎', '🍞'];
                            // new marker object
                            var marker = new google.maps.Marker({
                                map: map,
                                position: placeLatLng,
                                label: getRandomElement(labels, 1)
                            });
                            // attach a listener to each marker
                            google.maps.event.addListener(marker, 'click', function() {
                                // get details to be populated in infoWindow
                                Service.getDetails({
                                    placeId: result.place_id
                                }, function(place, status) {
                                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                                        // create an infoWindow object
                                        var infoWindow = new google.maps.InfoWindow({maxWidth: 150});
                                        // details to be placed in contentTemplate
                                        var placeDetails = {
                                            name: place.name,
                                            phone: place.formatted_phone_number,
                                        };
                                        if (navigator.platform.indexOf("iPhone") != -1 
                                            || (navigator.platform.indexOf("iPod") != -1)
                                            || (navigator.platform.indexOf("iPad") != -1)) {
                                             placeDetails.navLink = "maps://maps.google.com/maps?daddr=" + formatAddr(place.formatted_address);
                                        } else {
                                             placeDetails.navLink = "http://maps.google.com/maps?daddr=" + formatAddr(place.fomatted_address);
                                        }
                                        // construct infoWindow content
                                        var contentTemplate = "" +
                                            "<div id='content'>" +
                                            "<h3>{{name}}</h3>" +
                                            "<img src={{}} alt='place image'>" +
                                            "<p>Phone: {{phone}}</p>" +
                                            "<p>Navigate: {{navLink}}</p>" +
                                            "</div>";
                                        infoWindow.setContent(Mustache.render(contentTemplate, placeDetails));
                                        infoWindow.open(map, marker);
                                    }
                                });
                            });
                        }
                    }
                });
            } else {
                alert('Geocode error: ' + status);
            }
        });
    }
    </script>
</body>

</html>
