<!DOCTYPE html>
<html>
<head>
    <title>Resource Map</title>
    <meta charset="utf-8">
    <meta name="viewport" content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="assets/css/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
    html,
    body {
        height: 100%;
        margin: 0;
        padding: 0;
    }
    
    .container {
        height: 100%;
        width: 100%;
    }
    
    .nav-wrapper {
        padding: 0 1em;
    }
    
    .brand-logo {
        height: 1.5em;
        width: 1.5em;
        margin: .25em .15em;
    }
    
    #map {
        height: 65%;
        width: 100%;
    }
    
    .collection {
        margin: 0;
    }

    #language-modal {
        top: 30% !important;
        height: 35vh !important;
        width: 55vw !important;
    }

    .modal-content {
        height: 35vh;
    }

    .valign-wrapper {
        height: 100%;
    }

    .valign {
        width: 100%;
    }
    </style>
</head>
<body>
    <nav>
        <div class="nav-wrapper">
            <a href="#!" class="brand-logo"><img src='assets/img/safari.svg'></a>
            <a href="#" data-activates="mobile-demo" class="button-collapse"><i class="material-icons">menu</i></a>
            <ul class="right hide-on-med-and-down">
                <li><a href="index.html" class='waves-effect home'>Home</a></li>
                <li><a href="about.html" class='waves-effect about'>About</a></li>
                <li><a href="program-selection.html" class='waves-effect programs'>Programs</a></li>
                <li><a href="feedback.html" class='waves-effect feedback'>Feedback</a></li>
            </ul>
            <ul class="side-nav" id="mobile-demo">
                <li><a href="index.html" class='waves-effect home'>Home</a></li>
                <li><a href="about.html" class='waves-effect about'>About</a></li>
                <li><a href="program-selection.html" class='waves-effect programs'>Programs</a></li>
                <li><a href="feedback.html" class='waves-effect feedback'>Feedback</a></li>
            </ul>
        </div>
    </nav>
    <div class='container'>
        <div id="map"></div>
        <div id='language-modal' class='modal'>
            <div class='modal-content'>
                <div class='valign-wrapper'>
                    <div class='valign'>
                        <div class='col s12 center-align'>
                            <button id='english' class="btn waves-effect waves-light" type="submit" name="action">English
                            </button>
                        </div>
                        <div id='spanish' class='col s12 center-align' style='margin-top: 10%'>
                            <button class="btn waves-effect waves-light" type="submit" name="action">Espa√±ol</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id='form-modal' class='modal'>
            <div id='flexbox' class='modal-content'>
                <form class='col s12'>
                    <div class="row">
                        <div class="input-field col s12">
                            <i class="prefix material-icons">location_on</i>
                            <input id="zip" name='zip' type="text" class="validate" pattern='^[0-9]{5}(?:-[0-9]{4})?$' required='' aria-required='true'>
                            <label for="zip">Zip Code</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <i class="prefix material-icons">people</i>
                            <input id='houshold' name='household' type="number" class="validate" min='1' max='15'>
                            <label for="household">Household Members</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <i class="prefix material-icons">attach_money</i>
                            <input id="income" name='income' type="number" class="validate" min='1'>
                            <label for="email">Income</label>
                        </div>
                    </div>
                </form>
                <div class="row buttons">
                    <button class="btn waves-effect waves-light" type="submit" name="action">Submit
                        <i class="material-icons right">send</i>
                    </button>
                </div>
            </div>
        </div>
        <div id='reminder-modal' class='modal'>
            <div class='modal-content'>
                <ul class="collection with-header">
                    <li class="collection-header">
                        <h4>You may want to bring...</h4>
                    </li>
                    <li class="collection-item">Your California ID</li>
                    <li class="collection-item">Proof of income if employed</li>
                </ul>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/3.7.1/firebase.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.js'></script>
    <script>
        // random element utility
        function getRandomElement(arr, n) {
            var result = new Array(n),
                len = arr.length,
                taken = new Array(len);
            if (n > len) {
                throw new RangeError("getRandom: more elements taken than available");
            }
            while (n--) {
                var x = Math.floor(Math.random() * len);
                result[n] = arr[x in taken ? taken[x] : x];
                taken[x] = --len;
            }
            return result[0];
        }

        // format address for query string utility
        function formatAddr(address) {
            var temp = address.split('');
            for (var i = 0; i < temp.length; i++) {
                if (temp[i] === ',') {
                    temp.splice(i, 1);
                }
            }
            for (var j = 0; j < temp.length; j++) {
                if (temp[j] === ' ') {
                    temp.splice(j, 1, '+');
                }
            }
            return temp.join('');
        }

        // map render callback
        function init() { 
            console.log('init called');
            console.log('zip:', zip);  
            // variable to contain LatLng object converted from the user's zip
            var zipLatLng;
            // setup our geocoder object
            var Geocoder = new google.maps.Geocoder();

            Geocoder.geocode({
                address: zip
            }, function(results, status) {
                if (status == 'OK') {
                    // LatLng object returned by the callback passed to the '.geocode()' method
                    zipLatLng = results[0].geometry.location;
                    // create and assign map object
                    var map = new google.maps.Map(document.getElementById('map'), {
                        center: zipLatLng,
                        // 4 is ~country-level, while 10 is ~city-level
                        zoom: 10,
                        scrollwheel: false
                    });
                    // style map (retro)
                    // configure our map's style
                    var styledMapType = new google.maps.StyledMapType(
                        [{
                            elementType: 'geometry',
                            stylers: [{
                                color: '#ebe3cd'
                            }]
                        }, {
                            elementType: 'labels.text.fill',
                            stylers: [{
                                color: '#523735'
                            }]
                        }, {
                            elementType: 'labels.text.stroke',
                            stylers: [{
                                color: '#f5f1e6'
                            }]
                        }, {
                            featureType: 'administrative',
                            elementType: 'geometry.stroke',
                            stylers: [{
                                color: '#c9b2a6'
                            }]
                        }, {
                            featureType: 'administrative.land_parcel',
                            elementType: 'geometry.stroke',
                            stylers: [{
                                color: '#dcd2be'
                            }]
                        }, {
                            featureType: 'administrative.land_parcel',
                            elementType: 'labels.text.fill',
                            stylers: [{
                                color: '#ae9e90'
                            }]
                        }, {
                            featureType: 'landscape.natural',
                            elementType: 'geometry',
                            stylers: [{
                                color: '#dfd2ae'
                            }]
                        }, {
                            featureType: 'poi',
                            elementType: 'geometry',
                            stylers: [{
                                color: '#dfd2ae'
                            }]
                        }, {
                            featureType: 'poi',
                            elementType: 'labels.text.fill',
                            stylers: [{
                                color: '#93817c'
                            }]
                        }, {
                            featureType: 'poi.park',
                            elementType: 'geometry.fill',
                            stylers: [{
                                color: '#a5b076'
                            }]
                        }, {
                            featureType: 'poi.park',
                            elementType: 'labels.text.fill',
                            stylers: [{
                                color: '#447530'
                            }]
                        }, {
                            featureType: 'road',
                            elementType: 'geometry',
                            stylers: [{
                                color: '#f5f1e6'
                            }]
                        }, {
                            featureType: 'road.arterial',
                            elementType: 'geometry',
                            stylers: [{
                                color: '#fdfcf8'
                            }]
                        }, {
                            featureType: 'road.highway',
                            elementType: 'geometry',
                            stylers: [{
                                color: '#f8c967'
                            }]
                        }, {
                            featureType: 'road.highway',
                            elementType: 'geometry.stroke',
                            stylers: [{
                                color: '#e9bc62'
                            }]
                        }, {
                            featureType: 'road.highway.controlled_access',
                            elementType: 'geometry',
                            stylers: [{
                                color: '#e98d58'
                            }]
                        }, {
                            featureType: 'road.highway.controlled_access',
                            elementType: 'geometry.stroke',
                            stylers: [{
                                color: '#db8555'
                            }]
                        }, {
                            featureType: 'road.local',
                            elementType: 'labels.text.fill',
                            stylers: [{
                                color: '#806b63'
                            }]
                        }, {
                            featureType: 'transit.line',
                            elementType: 'geometry',
                            stylers: [{
                                color: '#dfd2ae'
                            }]
                        }, {
                            featureType: 'transit.line',
                            elementType: 'labels.text.fill',
                            stylers: [{
                                color: '#8f7d77'
                            }]
                        }, {
                            featureType: 'transit.line',
                            elementType: 'labels.text.stroke',
                            stylers: [{
                                color: '#ebe3cd'
                            }]
                        }, {
                            featureType: 'transit.station',
                            elementType: 'geometry',
                            stylers: [{
                                color: '#dfd2ae'
                            }]
                        }, {
                            featureType: 'water',
                            elementType: 'geometry.fill',
                            stylers: [{
                                color: '#b9d3c2'
                            }]
                        }, {
                            featureType: 'water',
                            elementType: 'labels.text.fill',
                            stylers: [{
                                color: '#92998d'
                            }]
                        }], {
                            name: 'Styled Map'
                        }
                    );
                    map.mapTypes.set('styled_map', styledMapType);
                    map.setMapTypeId('styled_map');
                    // set map viewport
                    map.setCenter(zipLatLng);
                    // create service object for our map
                    var Service = new google.maps.places.PlacesService(map);
                    // run a .nearbySearch() for the closest SNAP office 
                    Service.nearbySearch({
                        location: zipLatLng,
                        keyword: wic ? 'food stamps' : 'wic',
                        radius: '10000',
                    }, function(results, status) {
                        if (status == google.maps.places.PlacesServiceStatus.OK) {
                            var markers = [];
                            // iterate through results
                            for (var i = 0; i < results.length; i++) {
                                var result = results[i];
                                var placeLatLng = result.geometry.location;
                                // labels for each marker
                                var labels = ['üç†', 'üçÑ', 'ü•í', 'üå∂', 'üåΩ', 'ü•ï', 'ü•î', 'üçÜ', 'ü•ë', 'üçÖ', 'ü•ù', 'üçì', 'üçá', 'üçä', 'üçâ', 'üçé', 'üçû'];
                                // create an infoWindow object
                                var infoWindow = new google.maps.InfoWindow({
                                    maxWidth: 250
                                });
                                // the result's details
                                var placeDetails = {
                                    name: result.name
                                };
                                // format maps link based on user's operating system
                                if (navigator.platform.indexOf("iPhone") != -1 || (navigator.platform.indexOf("iPod") != -1) || (navigator.platform.indexOf("iPad") != -1)) {
                                    placeDetails.navLink = "maps://maps.google.com/maps?daddr=" + formatAddr(result.vicinity);
                                } else {
                                    placeDetails.navLink = "http://maps.google.com/maps?daddr=" + formatAddr(result.vicinity);
                                }
                                // if image, display
                                if (result.photos) {
                                    placeDetails.image = result.photos[0].getUrl({
                                        'maxWidth': 250
                                    });
                                    // construct infoWindow content
                                    var contentTemplate = "" +
                                        "<div id='content'>" +
                                        "<h5>{{name}}</h5>" +
                                        "<img src={{image}} alt={{name}}>" +
                                        "<p><a href={{navLink}}>Go</a></p>" +
                                        "</div>";
                                } else {
                                    var contentTemplate = "" +
                                        "<div id='content'>" +
                                        "<h5>{{name}}</h5>" +
                                        "<p><a href={{navLink}}>Go</a></p>" +
                                        "</div>";
                                }
                                // add content to this marker's infoWindow
                                infoWindow.setContent(Mustache.render(contentTemplate, placeDetails));
                                // create a marker for this place
                                var marker = new google.maps.Marker({
                                    map: map,
                                    label: getRandomElement(labels, 1),
                                    place: {
                                        location: result.geometry.location,
                                        placeId: result.place_id
                                    },
                                    infoWindow: infoWindow
                                });
                                // attach a listener to each marker
                                google.maps.event.addListener(marker, 'click', function() {
                                    return this.infoWindow.open(map, this);
                                });
                            }
                        }
                    });
                } else {
                    alert('Geocode error: ' + status);
                }
            });
        }
        
        $(document).ready(function() {
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyDkStdhgEH45RGotVbSO6CakBFFYppiGLs",
                authDomain: "cal-compass.firebaseapp.com",
                databaseURL: "https://cal-compass.firebaseio.com",
                storageBucket: "cal-compass.appspot.com",
                messagingSenderId: "888186000127"
            };

            firebase.initializeApp(config); 

            var rootRef = firebase.database().ref(); 

            // initialize side nav
            $(".button-collapse").sideNav({
                menuWidth: 125,
                edge: 'left',
                closeOnClick: true,
                draggable: true
            });

            var mapTrans = {
                menu: {
                    home: 'Casa',
                    about: 'Sobre',
                    programs: 'Programas',
                    feedback: 'Reacci√≥n'
                },
                snap: {
                    formModal: {
                        zip: 'C√≥digo Postal',
                        household: 'Miembros del Hogar',
                        income: 'Ingresos'
                    },
                    reminderModal: {
                        header: 'Quiz√°s quieras traer',
                        id: 'Su identificaci√≥n de California',
                        proof: 'Prueba de ingresos si se emplea'
                    }
                },
                wic: {}
            };

            var zip, wic; 

            // initialize modals
            $('#language-modal').modal(); 
            $('#form-modal').modal({dismissible: false});
            $('#reminder-modal').modal(); 

            firebase.auth().onAuthStateChanged(function(user) {
                // if user signed in
                if (user) {
                    firebase.database().ref('/users/' + user.uid).once('value').then(function(snap) {
                        if (snap.val().language === 'spanish') {
                            langState = 'es';
                            // translate nav to spanish
                            $('.home').text(mapTrans.home);
                            $('.about').text(mapTrans.about);
                            $('.programs').text(mapTrans.programs);
                            $('.feedback').text(mapTrans.feedback); 
                            // translate form modal to spanish
                            $("label[for='zip']").text(mapTrans.formModal.zip);
                            $("label[for='household']").text(mapTrans.formModal.household); 
                            $("label[for='income']").text(mapTrans.formModal.income);
                            // if we have a zipcode record for this user
                            if (snap.val().zipcode) {
                                zip = snap.val().zipcode; 
                                // zip is no longer required
                                $('#zip').attr('aria-required', 'false'); 
                                // append ('use current zip') 
                                $('.button').prepend($('<button>', {
                                    id: 'continue-zip',
                                    'class': 'btn waves-effect waves-light',
                                    text: 'Usa ' + snap.val().zipcode 
                                })); 
                            }
                            // translate reminder modal to spanish
                            $('.collection-header > h4').text(mapTrans.snap.reminderModal.header);
                            $('.collection').children('colletion-item').eq[0].text(mapTrans.snap.reminderModal.id);
                            $('.collection').children('colletion-item').eq[1].text(mapTrans.snap.reminderModal.proof);
                        } else {
                            if (snap.val().zipcode) {
                                // zip is no longer required
                                $('#zip').attr('aria-required', 'false'); 
                                // append ('use current zip') 
                                $('.button').prepend($('<button>', {
                                    id: 'continue-zip',
                                    'class': 'btn waves-effect waves-light',
                                    text: 'Use ' + snap.val().zipcode 
                                })); 
                            }
                        }
                        // open form modal
                        $('.form-modal').modal('open');
                        // 'use current zip' event listener, which kicks off map and opens reminder-modal
                        $('#continue-zip').on('click', function(event) {
                            event.preventDefault(); 
                            // assign zip
                            zip = snap.val().zipcode; 
                            // render map
                            if (langState === 'es') {
                                $('body').append("<script async defer src=https://maps.googleapis.com/maps/api/js?key=AIzaSyCgsIvh_6KHhGiGv8XHfTP2rUm_T42eH2E&language=en&libraries=places&callback=init />");
                            } else {
                                $('body').append("<script async defer src=https://maps.googleapis.com/maps/api/js?key=AIzaSyCgsIvh_6KHhGiGv8XHfTP2rUm_T42eH2E&language=es&libraries=places&callback=init />");
                            }
                            // close form-modal
                            $('#form-modal').modal('close'); 
                            // trigger reminder-modal
                            $('#reminder-modal').modal('open'); 
                        });
                        // submit event listener, which pushes zip to db, kicks off map and opens reminder-modal
                        $('button[type="submit"]').on('click', function(event) {
                            event.preventDefault(); 
                            zip = $('#zip').val().trim(); 
                            // push to firebase
                            var updates = {};
                            updates['/users/' + user.uid + '/zipcode/'] = zip;
                            rootRef.update(updates);
                            // render map
                            if (langState === 'es') {
                                $('body').append("<script async defer src=https://maps.googleapis.com/maps/api/js?key=AIzaSyCgsIvh_6KHhGiGv8XHfTP2rUm_T42eH2E&language=en&libraries=places&callback=init />");
                            } else {
                                $('body').append("<script async defer src=https://maps.googleapis.com/maps/api/js?key=AIzaSyCgsIvh_6KHhGiGv8XHfTP2rUm_T42eH2E&language=es&libraries=places&callback=init />");
                            }
                            // close form-modal
                            $('#form-modal').modal('close'); 
                            // trigger reminder-modal
                            $('#reminder-modal').modal('open'); 
                        });
                    });
                } 
            }); 
        });
        ////////// TO DO
        // window.referrer => which urls ref user to wic? 
        // google translate api for infoWindows
        // wic map up and running
        // how to enforce 'require' on modal forms? jquery validation + CSS
        // gmail feedback
        // wic vendor map
        // js modules (import/export)
        // chart js
        // table feedback
    </script>
</body>
</html>
