<!DOCTYPE html>
<html>

<head>
    <title>SNAP Office Locator</title>
    <meta charset="utf-8">
    <meta name="viewport" content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="assets/css/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        .container {
            height: 100%;
            width: 100%;
        }

        .nav-wrapper {
            padding: 0 1em;
        }

        .brand-logo {
            height: 1.5em;
            width: 1.5em;
            margin: .25em .15em;
        }

        #map {
            height: 65%;
            width: 100%;
        }

        .collection {
            margin: 0;
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-wrapper">
            <a href="#!" class="brand-logo"><img src='assets/img/safari.svg'></a>
            <a href="#" data-activates="mobile-demo" class="button-collapse"><i class="material-icons">menu</i></a>
            <ul class="right hide-on-med-and-down">
                <li><a href="index.html">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="program-selection.html">Programs</a></li>
                <li><a href="feedbck.html">Feedback</a></li>
            </ul>
            <ul class="side-nav" id="mobile-demo">
                <li><a href="index.html">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="program-selection.html">Programs</a></li>
                <li><a href="feedback.html">Feedback</a></li>
            </ul>
        </div>
    </nav>
    <div class='container'>
        <div id="map"></div>
            <div class='modal-content'>
                <ul class="collection with-header">
                    <li class="collection-header"><h4>Don't forget...</h4></li>
                    <li class="collection-item">Your driver's license</li>
                    <li class="collection-item">A second item</li>
                    <li class="collection-item">A third item</li>
                </ul>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/3.7.1/firebase.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.js'></script>
    <script>
    $(document).ready(function() {
        // Initialize Firebase
       var config = {
            apiKey: "AIzaSyDkStdhgEH45RGotVbSO6CakBFFYppiGLs",
            authDomain: "cal-compass.firebaseapp.com",
            databaseURL: "https://cal-compass.firebaseio.com",
            storageBucket: "cal-compass.appspot.com",
            messagingSenderId: "888186000127"
        };
        firebase.initializeApp(config);

        firebase.auth().onAuthStateChanged(function(user) {

            if (user) {
                console.log(user.displayName, "is logged in");
                // User is signed in.
                // write updates
                // rootRef.update(updates);
                // off to maps 
                // window.location = "mapFS.html";
            } else {
                console.log('No user is signed in.');
            }
        });
        // bring up modal
        $('#modal-one').modal('open'); 
        // initialize side nav
        $(".button-collapse").sideNav({
            menuWidth: 125,
            edge: 'left',
            closeOnClick: true,
            draggable: true
        });
    });
    
    // determines language to render for map
    var langState = 'en';

    switch (langState) {
        case 'en':
            $('body').append("<script async defer src=https://maps.googleapis.com/maps/api/js?key=AIzaSyCgsIvh_6KHhGiGv8XHfTP2rUm_T42eH2E&language=en&libraries=places&callback=init />");
            break;
        case 'es':
            $('body').append("<script async defer src=https://maps.googleapis.com/maps/api/js?key=AIzaSyCgsIvh_6KHhGiGv8XHfTP2rUm_T42eH2E&language=es&libraries=places&callback=init />");
            break;
    }

    // random element utility
    var getRandomElement = function(arr, n) {
        var result = new Array(n),
            len = arr.length,
            taken = new Array(len);
        if (n > len) {
            throw new RangeError("getRandom: more elements taken than available");
        }
        while (n--) {
            var x = Math.floor(Math.random() * len);
            result[n] = arr[x in taken ? taken[x] : x];
            taken[x] = --len;
        }
        return result[0];
    };

    // format address for query string utility
    var formatAddr = function(address) {
        var temp = address.split('');
        for (var i = 0; i < temp.length; i++) {
            if (temp[i] === ',') {
                temp.splice(i, 1);
            }
        }
        for (var j = 0; j < temp.length; j++) {
            if (temp[j] === ' ') {
                temp.splice(j, 1, '+');
            }
        }
        return temp.join('');
    };

    // map render callback
    function init() {
        // variable to contain LatLng object converted from the user's zip
        var zipLatLng;
        // setup our geocoder object
        var Geocoder = new google.maps.Geocoder();

        Geocoder.geocode({
            address: '94601'
        }, function(results, status) {
            if (status == 'OK') {
                // LatLng object returned by the callback passed to the '.geocode()' method
                zipLatLng = results[0].geometry.location;
                // create and assign map object
                var map = new google.maps.Map(document.getElementById('map'), {
                    center: zipLatLng,
                    // 4 is ~country-level, while 10 is ~city-level
                    zoom: 10,
                    scrollwheel: false
                });
                // style map (retro)
                // configure our map's style
                var styledMapType = new google.maps.StyledMapType(
                    [{
                        elementType: 'geometry',
                        stylers: [{
                            color: '#ebe3cd'
                        }]
                    }, {
                        elementType: 'labels.text.fill',
                        stylers: [{
                            color: '#523735'
                        }]
                    }, {
                        elementType: 'labels.text.stroke',
                        stylers: [{
                            color: '#f5f1e6'
                        }]
                    }, {
                        featureType: 'administrative',
                        elementType: 'geometry.stroke',
                        stylers: [{
                            color: '#c9b2a6'
                        }]
                    }, {
                        featureType: 'administrative.land_parcel',
                        elementType: 'geometry.stroke',
                        stylers: [{
                            color: '#dcd2be'
                        }]
                    }, {
                        featureType: 'administrative.land_parcel',
                        elementType: 'labels.text.fill',
                        stylers: [{
                            color: '#ae9e90'
                        }]
                    }, {
                        featureType: 'landscape.natural',
                        elementType: 'geometry',
                        stylers: [{
                            color: '#dfd2ae'
                        }]
                    }, {
                        featureType: 'poi',
                        elementType: 'geometry',
                        stylers: [{
                            color: '#dfd2ae'
                        }]
                    }, {
                        featureType: 'poi',
                        elementType: 'labels.text.fill',
                        stylers: [{
                            color: '#93817c'
                        }]
                    }, {
                        featureType: 'poi.park',
                        elementType: 'geometry.fill',
                        stylers: [{
                            color: '#a5b076'
                        }]
                    }, {
                        featureType: 'poi.park',
                        elementType: 'labels.text.fill',
                        stylers: [{
                            color: '#447530'
                        }]
                    }, {
                        featureType: 'road',
                        elementType: 'geometry',
                        stylers: [{
                            color: '#f5f1e6'
                        }]
                    }, {
                        featureType: 'road.arterial',
                        elementType: 'geometry',
                        stylers: [{
                            color: '#fdfcf8'
                        }]
                    }, {
                        featureType: 'road.highway',
                        elementType: 'geometry',
                        stylers: [{
                            color: '#f8c967'
                        }]
                    }, {
                        featureType: 'road.highway',
                        elementType: 'geometry.stroke',
                        stylers: [{
                            color: '#e9bc62'
                        }]
                    }, {
                        featureType: 'road.highway.controlled_access',
                        elementType: 'geometry',
                        stylers: [{
                            color: '#e98d58'
                        }]
                    }, {
                        featureType: 'road.highway.controlled_access',
                        elementType: 'geometry.stroke',
                        stylers: [{
                            color: '#db8555'
                        }]
                    }, {
                        featureType: 'road.local',
                        elementType: 'labels.text.fill',
                        stylers: [{
                            color: '#806b63'
                        }]
                    }, {
                        featureType: 'transit.line',
                        elementType: 'geometry',
                        stylers: [{
                            color: '#dfd2ae'
                        }]
                    }, {
                        featureType: 'transit.line',
                        elementType: 'labels.text.fill',
                        stylers: [{
                            color: '#8f7d77'
                        }]
                    }, {
                        featureType: 'transit.line',
                        elementType: 'labels.text.stroke',
                        stylers: [{
                            color: '#ebe3cd'
                        }]
                    }, {
                        featureType: 'transit.station',
                        elementType: 'geometry',
                        stylers: [{
                            color: '#dfd2ae'
                        }]
                    }, {
                        featureType: 'water',
                        elementType: 'geometry.fill',
                        stylers: [{
                            color: '#b9d3c2'
                        }]
                    }, {
                        featureType: 'water',
                        elementType: 'labels.text.fill',
                        stylers: [{
                            color: '#92998d'
                        }]
                    }], {
                        name: 'Styled Map'
                    }
                );
                map.mapTypes.set('styled_map', styledMapType);
                map.setMapTypeId('styled_map');
                // set map viewport
                map.setCenter(zipLatLng);
                // create service object for our map
                var Service = new google.maps.places.PlacesService(map);
                // run a .nearbySearch() for the closest SNAP office 
                Service.nearbySearch({
                    location: zipLatLng,
                    keyword: 'food stamps',
                    radius: '10000',
                }, function(results, status) {
                    if (status == google.maps.places.PlacesServiceStatus.OK) {
                        var markers = [];
                        // iterate through results
                        for (var i = 0; i < results.length; i++) {
                            var result = results[i];
                            var placeLatLng = result.geometry.location;
                            // labels for each marker
                            var labels = ['ðŸ ', 'ðŸ„', 'ðŸ¥’', 'ðŸŒ¶', 'ðŸŒ½', 'ðŸ¥•', 'ðŸ¥”', 'ðŸ†', 'ðŸ¥‘', 'ðŸ…', 'ðŸ¥', 'ðŸ“', 'ðŸ‡', 'ðŸŠ', 'ðŸ‰', 'ðŸŽ', 'ðŸž'];
                            // create an infoWindow object
                            var infoWindow = new google.maps.InfoWindow({
                                maxWidth: 250
                            });
                            // the result's details
                            var placeDetails = {
                                name: result.name
                            };
                            // format maps link based on user's operating system
                            if (navigator.platform.indexOf("iPhone") != -1 || (navigator.platform.indexOf("iPod") != -1) || (navigator.platform.indexOf("iPad") != -1)) {
                                placeDetails.navLink = "maps://maps.google.com/maps?daddr=" + formatAddr(result.vicinity);
                            } else {
                                placeDetails.navLink = "http://maps.google.com/maps?daddr=" + formatAddr(result.vicinity);
                            }
                            // if image, display
                            if (result.photos) {
                                placeDetails.image = result.photos[0].getUrl({'maxWidth': 250});
                                // construct infoWindow content
                                var contentTemplate = "" +
                                                      "<div id='content'>" +
                                                      "<h5>{{name}}</h5>" +
                                                      "<img src={{image}} alt={{name}}>" +
                                                      "<p><a href={{navLink}}>Go</a></p>" +
                                                      "</div>";
                            } else {
                                var contentTemplate = "" +
                                                      "<div id='content'>" +
                                                      "<h5>{{name}}</h5>" +
                                                      "<p><a href={{navLink}}>Go</a></p>" +
                                                      "</div>";
                            }
                            // add content to this marker's infoWindow
                            infoWindow.setContent(Mustache.render(contentTemplate, placeDetails)); 
                            // create a marker for this place
                            var marker = new google.maps.Marker({
                                map: map,
                                label: getRandomElement(labels, 1),
                                place: {
                                    location: result.geometry.location,
                                    placeId: result.place_id
                                },
                                infoWindow: infoWindow   
                            }); 
                            // attach a listener to each marker
                            google.maps.event.addListener(marker, 'click', function() {
                                return this.infoWindow.open(map, this); 
                            });
                        }
                    }
                });
            } else {
                alert('Geocode error: ' + status);
            }
        });
    }
    </script>
</body>
</html>
